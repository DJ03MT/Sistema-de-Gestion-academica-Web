<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Secretaría - Sistema CEO</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/styles/menusecretaria.css">
  <style>
    .documents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .document-card {
      background: #ffffff;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 25px;
      border-left: 5px solid var(--primary);
      transition: var(--transition);
    }

    .document-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .document-icon {
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 15px;
    }

    .document-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 15px;
    }

    /* Estilos para el formulario de búsqueda */
    .search-form {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .search-form .search-input {
      flex-grow: 1;
      padding: 10px 12px;
      border: 1px solid var(--light-gray);
      border-radius: 8px;
      font-size: 0.95rem;
    }

    .search-form .search-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .search-form .btn-primary {
      flex-shrink: 0;
      /* Evita que el botón se encoja */
    }
  </style>
</head>

<body>
  <div class="dashboard-container">
    <div class="sidebar">
      <div class="user-profile">
        <div class="avatar">
          <img src="<%= user.photo %>" alt="Foto" class="user-photo" style="width:100%; height:100%; border-radius: 50%;">
        </div>
        <div class="user-name"><%= user.name %></div>
        <div class="user-info"><%= user.rol %></div>
        <div class="user-info">Colegio Enrique de Osso</div>
      </div>

      <ul class="nav-links">
        <li><a href="#" class="nav-link active" data-section="welcome"><i class="fas fa-home"></i> Inicio</a></li>
        <li><a href="#" class="nav-link" data-section="alumnos"><i class="fas fa-users"></i> Gestión de Alumnos</a></li>
        <li><a href="#" class="nav-link" data-section="profesores"><i class="fas fa-chalkboard-teacher"></i> Gestión de Profesores</a></li>
        <li><a href="#" class="nav-link" data-section="documentos"><i class="fas fa-file-alt"></i> Generar Documentos</a></li>
        <li><a href="#" class="nav-link" data-section="estadisticas"><i class="fas fa-chart-bar"></i> Estadísticas</a></li>
      </ul>

      <div class="logout-section">
        <% if (user.rol === 'DIRECTOR') { %>
        <a href="/admin" class="logout-btn" style="background: var(--primary-dark); margin-bottom: 10px; justify-content: center;">
          <i class="fas fa-shield-alt"></i>&nbsp; Volver al Admin
        </a>
        <% } %>
        <a href="/logout" class="logout-btn" id="logoutBtnLink">
          <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
        </a>
      </div>
    </div>

    <div class="main-content">

      <div id="welcome" class="content-section active">
        <div class="content-header">
          <div>
            <h1>Bienvenida, <%= user.name.split(' ')[0] %></h1>
            <p>Panel de Secretaría - Sistema CEO</p>
          </div>
          <div class="current-date" id="currentDate"></div>
        </div>
        <div class="welcome-section">
          <div class="welcome-icon"><i class="fas fa-user-tie"></i></div>
          <h2 class="welcome-title">Panel de Control de Secretaría</h2>
          <p class="welcome-subtitle">Gestiona estudiantes, profesores, genera documentos y consulta estadísticas institucionales.</p>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon"><i class="fas fa-users"></i></div>
              <div class="stat-number"><%= stats.totalEstudiantes %></div>
              <div class="stat-label">Estudiantes Activos</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon"><i class="fas fa-chalkboard-teacher"></i></div>
              <div class="stat-number"><%= stats.totalProfesores %></div>
              <div class="stat-label">Profesores Activos</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon" style="color: #ffc107;"><i class="fas fa-award"></i></div>
              <div class="stat-number" style="font-size: 1.8rem; line-height: 2.5rem;"><%= valorDelMes %></div>
              <div class="stat-label">Valor del Mes</div>
            </div>
            <a href="<%= calendarioLink %>" target="_blank" style="text-decoration: none;">
              <div class="stat-card">
                <div class="stat-icon" style="color: #2a9d8f;"><i class="fas fa-file-invoice"></i></div>
                <div class="stat-number" style="font-size: 1.5rem; line-height: 2.5rem;">Calendario</div>
                <div class="stat-label">Abrir Google Doc</div>
              </div>
            </a>
          </div>
        </div>
      </div>

      <div id="alumnos" class="content-section">
        <div class="content-header">
          <h1><i class="fas fa-users"></i> Gestión de Estudiantes</h1>
          <p>Administra la información de los estudiantes</p>
        </div>
        <div class="section-container">
          <% if (typeof successMessage !== 'undefined' && successMessage) { %>
          <div class="alert alert-success"><i class="fas fa-check-circle"></i> <%= successMessage %></div>
          <% } %>
          <% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
          <div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> <%= errorMessage %></div>
          <% } %>

          <div class="section-header">
            <div class="section-title">Lista de Estudiantes (<%= estudiantes.length %>)</div>
            <a href="/secretaria/agregar-estudiante" class="btn btn-primary" style="text-decoration: none;">
              <i class="fas fa-plus"></i> Nuevo Estudiante
            </a>
          </div>
          <div class="search-bar">
            <input type="text" class="search-input" id="searchAlumnos" placeholder="Buscar estudiante por nombre...">
            <button class="search-btn"><i class="fas fa-search"></i></button>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Código de Estudiante</th>
                  <th>Nombre Completo</th>
                  <th>Curso</th>
                  <th>Contacto</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="tbodyAlumnos">
                <% if (typeof estudiantes !== 'undefined' && estudiantes.length > 0) { %>
                <% estudiantes.forEach(est => { %>
                <tr>
                  <td><%= est.CODIGO_ESTUDIANTE %></td>
                  <td> <%= est.PRIMER_NOMBRE %> <%= est.SEGUNDO_NOMBRE %> <%= est.PRIMER_APELLIDO %> <%= est.SEGUNDO_APELLIDO %> </td>
                  <td>
                    <% if (est.GRADO && est.SECCION) { %>
                    <%= est.GRADO %> "<%= est.SECCION %>"
                    <% } else if (est.NombreEstado === 'Retirado') { %>
                    <span style="color: #e74c3c; font-style: italic;">Retirado</span>
                    <% } else { %>
                    <span style="color: #e74c3c; font-style: italic;">Sin Inscribir</span>
                    <% } %>
                  </td>
                  <td><%= est.CELULAR || '-' %></td>
                  <td>
                    <span class="status-badge <%= est.NombreEstado === 'Activo' ? 'status-active' : (est.NombreEstado === 'Retirado' ? 'status-danger' : 'status-inactive') %>">
                      <%= est.NombreEstado %>
                    </span>
                  </td>
                  <td>

                    <div class="action-buttons">

                      <a href="/secretaria/editar-estudiante/<%= est.id_estudiante %>" class="btn-action btn-edit" style="text-decoration: none;">
                        <i class="fas fa-edit"></i> Editar
                      </a>

                      <a href="/secretaria/estudiante/<%= est.id_estudiante %>/historial" class="btn-action btn-edit" style="text-decoration: none; background: #e9ecef; color: #495057;">
                        <i class="fas fa-history"></i> Historial
                      </a>
                      <% if (est.NombreEstado === 'Activo') { %>
                      <button class="btn-action btn-delete btn-retirar" data-id="<%= est.id_estudiante %>" data-nombre="<%= est.PRIMER_NOMBRE %> <%= est.PRIMER_APELLIDO %>">
                        <i class="fas fa-user-minus"></i> Retirar
                      </button>
                      <% } %>
                    </div>
                  </td>
                </tr>
                <% }); %>
                <% } else { %>
                <tr>
                  <td colspan="6" style="text-align: center; padding: 20px;">No se encontraron estudiantes activos.</td>
                </tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="profesores" class="content-section">
        <div class="content-header">
          <h1><i class="fas fa-chalkboard-teacher"></i> Gestión de Profesores</h1>
          <p>Administra la información del personal docente</p>
        </div>
        <div class="section-container">
          <div class="section-header">
            <div class="section-title">Lista de Profesores Activos (<%= profesores.length %>)</div>
            <div>
              <a href="/secretaria/profesores/inactivos" class="btn" style="background: #6c757d; color: white; text-decoration: none; margin-right: 10px;">
                <i class="fas fa-archive"></i> Ver Inactivos
              </a>
              <a href="/secretaria/agregar-profesor" class="btn btn-primary" style="text-decoration: none;">
                <i class="fas fa-plus"></i> Nuevo Profesor
              </a>
            </div>
          </div>
          <div class="search-bar">
            <input type="text" class="search-input" id="searchProfesores" placeholder="Buscar profesor por nombre...">
            <button class="search-btn"><i class="fas fa-search"></i></button>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nombre Completo</th>
                  <th>Especialidad</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="tbodyProfesores">
                <% if (typeof profesores !== 'undefined' && profesores.length > 0) { %>
                <% profesores.forEach(profe => { %>
                <tr>
                  <td>PROF-<%= profe.ID_PROFESOR %></td>
                  <td><%= profe.PRIMER_NOMBRE %> <%= profe.SEGUNDO_NOMBRE %> <%= profe.PRIMER_APELLIDO %> <%= profe.SEGUNDO_APELLIDO %> </td>
                  <td><%= profe.ESPECIALIDAD_DOCENTE || 'No especificada' %></td>
                  <td>
                    <div class="action-buttons">
                      <a href="/secretaria/editar-profesor/<%= profe.ID_PROFESOR %>" class="btn-action btn-edit" style="text-decoration: none;">
                        <i class="fas fa-edit"></i> Editar
                      </a>
                      <button class="btn-action btn-delete" data-id="<%= profe.ID_PROFESOR %>" data-nombre="<%= profe.PRIMER_NOMBRE %> <%= profe.PRIMER_APELLIDO %>">
                        <i class="fas fa-trash"></i> Desactivar
                      </button>
                    </div>
                  </td>
                </tr>
                <% }); %>
                <% } else { %>
                <tr>
                  <td colspan="4" style="text-align: center; padding: 20px;">No se encontraron profesores activos.</td>
                </tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="documentos" class="content-section">
        <div class="content-header">
          <h1><i class="fas fa-file-alt"></i> Generar Documentos</h1>
          <p>Genera certificados, actas y reportes institucionales</p>
        </div>

        <div class="documents-grid">

          <div class="document-card">
            <div class="document-icon"><i class="fas fa-file-pdf"></i></div>
            <div class="document-title">Hojas de Matrícula (por Grado)</div>
            <p style="color: var(--gray); margin-bottom: 15px;">Genere un PDF con las matrículas de todos los estudiantes activos <strong>de un grado específico</strong>.</p>

            <form action="/secretaria/estudiantes/matricula-por-grado" method="GET" target="_blank" class="search-form">
              <select name="ID_Grado" class="search-input" required>
                <option value="">-- Seleccione un Grado --</option>
                <% if (typeof grados !== 'undefined') { %>
                <% grados.forEach(grado => { %>
                <option value="<%= grado.ID_Grado %>"><%= grado.NombreGrado %></option>
                <% }); %>
                <% } %>
              </select>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-print"></i>
              </button>
            </form>
          </div>

          <div class="document-card">
            <div class="document-icon"><i class="fas fa-user-check"></i></div>
            <div class="document-title">Hoja de Matrícula (Individual)</div>
            <p style="color: var(--gray); margin-bottom: 15px;">Busque un estudiante por su nombre completo para generar solo su hoja.</p>

            <form action="/secretaria/documentos/matricula-por-nombre" method="GET" target="_blank" class="search-form">
              <input type="text" name="nombre" class="search-input" placeholder="Ingrese el nombre completo..." required>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i>
              </button>
            </form>
          </div>

          <div class="document-card" style="border-left-color: var(--gray); opacity: 0.7;">
            <div class="document-icon" style="color: var(--gray);"><i class="fas fa-file-certificate"></i></div>
            <div class="document-title">Certificado de Estudios</div>
            <p style="color: var(--gray); margin-bottom: 15px;">(Función en desarrollo...)</p>
            <button class="btn" style="background: var(--light-gray); color: var(--gray); width: 100%; justify-content: center;" disabled>
              <i class="fas fa-download"></i> Generar
            </button>
          </div>

        </div>
      </div>

      <div id="estadisticas" class="content-section">
        <div class="content-header">
          <h1><i class="fas fa-chart-bar"></i> Estadísticas Institucionales</h1>
          <p>Visualiza datos y métricas del colegio</p>
        </div>
        <div class="charts-container">
          <div class="chart-card">
            <div class="chart-title">Distribución por Grados</div>
            <div class="chart-placeholder">Gráfico de estudiantes por grado</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="retiroModalBackdrop" style="display: none;">
    <div class="modal" id="retiroModal">
      <div class="modal-header">
        <h3 id="retiroModalTitle">Retirar Estudiante</h3>
        <button class="modal-close" id="closeModalBtn">&times;</button>
      </div>
      <div class="modal-body">
        <p>Estás a punto de retirar a <strong id="retiroModalEstudiante"></strong>.</p>
        <div class="form-group">
          <label for="retiroMotivo" class="required">Motivo del Retiro:</label>
          <textarea id="retiroMotivo" rows="4" placeholder="Escriba aquí la razón del retiro..."></textarea>
          <small id="retiroError" class="retiro-error-msg" style="display: none;">El motivo es obligatorio.</small>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelModalBtn">Cancelar</button>
        <button class="btn btn-danger" id="confirmRetiroBtn">
          <i class="fas fa-user-minus"></i> Confirmar Retiro
        </button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // --- NAVEGACIÓN ENTRE SECCIONES ---
      const navLinks = document.querySelectorAll('.nav-link');
      const contentSections = document.querySelectorAll('.content-section');
      navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          navLinks.forEach(item => item.classList.remove('active'));
          this.classList.add('active');
          const sectionId = this.getAttribute('data-section');
          contentSections.forEach(section => section.classList.remove('active'));
          document.getElementById(sectionId).classList.add('active');
        });
      });

      // --- FECHA ACTUAL ---
      const currentDateElement = document.getElementById('currentDate');
      if (currentDateElement) {
        const now = new Date();
        const options = {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        };
        currentDateElement.textContent = now.toLocaleDateString('es-ES', options);
      }

      // --- CERRAR SESIÓN ---
      document.getElementById('logoutBtnLink').addEventListener('click', function(e) {
        if (!confirm('¿Estás seguro de que deseas cerrar sesión?')) {
          e.preventDefault();
        }
      });

      // --- LÓGICA DE BÚSQUEDA ---
      function setupTableSearch(inputId, tableBodyId, cellIndex) {
        const searchInput = document.getElementById(inputId);
        const tableBody = document.getElementById(tableBodyId);
        if (!searchInput || !tableBody) return;
        const rows = tableBody.querySelectorAll('tr');
        searchInput.addEventListener('keyup', function() {
          const query = searchInput.value.toLowerCase();
          rows.forEach(row => {
            const nameCell = row.querySelectorAll('td')[cellIndex];
            if (nameCell) {
              const name = nameCell.textContent.toLowerCase();
              row.style.display = name.includes(query) ? '' : 'none';
            }
          });
        });
      }
      setupTableSearch('searchAlumnos', 'tbodyAlumnos', 1);
      setupTableSearch('searchProfesores', 'tbodyProfesores', 1);

      // --- LÓGICA DE DESACTIVAR PROFESOR ---
      document.querySelectorAll('.btn-delete:not(.btn-retirar)').forEach(button => {
        button.addEventListener('click', async function(e) {
          const id = this.getAttribute('data-id');
          const nombre = this.getAttribute('data-nombre');
          let url = `/secretaria/profesores/${id}`; // Asumiendo que esta es tu ruta DELETE
          let confirmMessage = `¿Estás seguro de que deseas desactivar el login del profesor ${nombre}?`;

          if (confirm(confirmMessage)) {
            try {
              // Asumiendo que usas DELETE para desactivar (o POST, ajusta según tu ruta)
              const response = await fetch(url, {
                method: 'DELETE'
              });
              const data = await response.json();
              if (data.success) {
                alert(data.message);
                window.location.reload();
              } else {
                alert('No se pudo completar la acción: ' + data.message);
              }
            } catch (err) {
              console.error('Error con fetch:', err);
              alert('Error de conexión al actualizar.');
            }
          }
        });
      });

      // ----- Lógica del Modal de Retiro -----
      const modalBackdrop = document.getElementById('retiroModalBackdrop');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const cancelModalBtn = document.getElementById('cancelModalBtn');
      const confirmRetiroBtn = document.getElementById('confirmRetiroBtn');
      const retiroMotivoInput = document.getElementById('retiroMotivo');
      const retiroError = document.getElementById('retiroError');

      document.querySelectorAll('.btn-retirar').forEach(button => {
        button.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          const nombre = this.getAttribute('data-nombre');
          document.getElementById('retiroModalEstudiante').textContent = nombre;
          confirmRetiroBtn.setAttribute('data-id', id);
          retiroMotivoInput.value = '';
          retiroError.style.display = 'none';
          modalBackdrop.style.display = 'flex';
        });
      });

      function closeModal() {
        modalBackdrop.style.display = 'none';
      }
      if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
      if (cancelModalBtn) cancelModalBtn.addEventListener('click', closeModal);
      if (modalBackdrop) modalBackdrop.addEventListener('click', function(e) {
        if (e.target === modalBackdrop) {
          closeModal();
        }
      });

      if (confirmRetiroBtn) confirmRetiroBtn.addEventListener('click', async function() {
        const id = this.getAttribute('data-id');
        const motivo = retiroMotivoInput.value;

        if (!motivo || motivo.trim() === '') {
          retiroError.style.display = 'block';
          retiroMotivoInput.focus();
          return;
        }

        retiroError.style.display = 'none';

        try {
          const response = await fetch(`/secretaria/estudiantes/${id}/retirar`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              motivo: motivo
            })
          });

          const data = await response.json();

          if (data.success) {
            alert(data.message);
            window.location.reload();
          } else {
            alert('No se pudo completar la acción: ' + (data.message || 'Error desconocido'));
          }
        } catch (err) {
          console.error('Error con fetch:', err);
          alert('Error de conexión al procesar el retiro.');
        }
      });
    });
  </script>
</body>

</html>